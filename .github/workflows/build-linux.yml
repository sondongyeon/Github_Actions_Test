name: Build on Linux (DooD)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: my-web-app
  CONTAINER_NAME: web-server
  PORT: 9094

jobs:
  build:
    runs-on: [self-hosted, Linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Build
        run: npm run build

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:latest .
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:${{ github.sha }}
          echo "Image built: $IMAGE_NAME:latest"

      - name: Deploy container
        run: |
          # 기존 컨테이너 중지 및 제거
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true

          # 새 컨테이너 실행
          docker run -d \
            --name $CONTAINER_NAME \
            -p $PORT:80 \
            --restart unless-stopped \
            $IMAGE_NAME:latest

          sleep 3

          # 상태 확인
          if docker ps | grep -q $CONTAINER_NAME; then
            echo "Container is running"
          else
            echo "Container failed to start"
            docker logs $CONTAINER_NAME
            exit 1
          fi

      - name: Cleanup old images
        run: |
          # 최근 3개 태그 제외하고 삭제
          docker images $IMAGE_NAME --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | tail -n +4 | awk '{print $1}' | \
            xargs -r docker rmi 2>/dev/null || true

          # dangling 이미지 정리
          docker image prune -f

      - name: Show access info
        run: |
          IP=$(hostname -I | awk '{print $1}')
          echo "======================================"
          echo "Deployment complete!"
          echo "Local: http://localhost:$PORT"
          echo "Network: http://${IP}:$PORT"
          echo "======================================"
